#!/bin/sh
# Music player thing.  The way I organise music means that I don't
# have to have any explicit playlist format file mess.
#
# The base directory is ~/med/mus.  Each artist gets a folder.  Each
# album gets their own folder.  If it has more than a single disc,
# they are labelled as D1, D2, and so on.
#
# I prefer to listen to albums in bulk so simply prompting to play an
# album when a mpv instance is already not running is good enough for
# my needs.

sock=/tmp/mussock
cmd="socat - $sock"

getprop(){
	printf '{"command":["get_property_string","%s"]}\n' "$1" |$cmd |{
		read -r out
		out="${out#*\"data\":\"}"
		echo "${out%%\"*}"
	}
}

setprop(){
	printf '{"command":["set_property","%s",%s]}\n' "$1" "$2" |$cmd
}

# Pause or play.
pause(){
	getprop pause |{
		read -r p
		case $p in
		no) setprop pause true ;;
		yes) setprop pause false ;;
		esac
	}
}

next(){
	echo '{"command":["playlist-next"]}' |$cmd
}

prev(){
	echo '{"command":["playlist-prev"]}' |$cmd
}

loop(){
	getprop loop-file |{
		read -r p
		case $p in
		no) setprop loop-file true ;;
		inf) setprop loop-file false ;;
		esac
	}
}

current(){
	getprop path |sed -e "s|$HOME/med/mus/||" -e 'y/_/ /' -e 's|/| --- |g' |{
		read -r file

		getprop duration |{
			read -r total
			total=${total%%.*}

			getprop time-pos |{
				read -r now
				now=${now%%.*}

				awesome-client <<EOF
local notify = require("naughty")
notify.notify{
	title = "currently playing:",
	text = "($((now/60)):$((now%60))/$((total/60)):$((total%60))) $file"
}
EOF
			}
		}
	}
}

quit(){
	echo '{"command":["quit"]}' |$cmd
	rm $sock
}

:|$cmd || quit

if [ -S $sock ]; then
	if [ -z "$1" ]; then
		echo 'pause
next
prev
loop
current
quit' |menu sel |{
			read -r cmd
			[ -n "$cmd" ] && mus "$cmd"
		}
	else
		g=$1
		shift
		$g "$@"
	fi
else
	# GNU find time
	find $HOME/med/mus -type d -printf '%P\n' |menu sel |{
		read -r dir
		mpv --input-ipc-server="$sock" "$HOME/med/mus/$dir"
	}
fi
